---
title: redis设计与实现 chr11 aof持久化
date: 2021-12-16 18:33:37
categories:	Redis基础
tags: Redis
---



# 总结

AOF持久化章节主要介绍持久化机制，时机，重写过程。AOF文件**载入时不会判断键是否过期**，只是执行文件中的命令。AOF开启后，执行一个写命令就会被**追加到aof_buf**中。AOF持久化过程是根据其同步策略配置，一次事件循环，一定会将aof_buf中的命令写到操作系统缓冲区，在根据配置考虑是否需要**强制写入磁盘**。AOF重写是对文件的瘦身计划，为了解决子进程执行AOF文件重写前后数据库状态不一致的问题，AOF重写缓冲区会**记录在这期间对数据库的变更**，子进程结束后**发信号**，主进程接收后会**进入阻塞阶段**，同步重写缓冲区至新的AOF文件。

# AOF持久化

除了RDB持久化外，redis还提供了AOF持久化功能。区别如下：

- RDB通过保存数据库中键值对记录数据库状态
- AOF通过保存服务器执行的**写命令**来记录数据库状态
- 它主要**解决**数据持久化的**实时性问题**。默认是不开启的。



## AOF 持久化的实现

AOF持久化分为三步：

- 命令追加：写命令append到redisServer全局变量的aof_buf成员【aof缓冲区】中
- 文件写入
- 文件同步



### AOF写入与同步

每次一个事件循环结束前调用flushAppendOnlyFile函数，考虑是否将aof_buf内容写到AOF文件里（appendfsync参数决定）

- always：所有内容**写入并同步**到AOF文件（写入的是缓冲区，同步时从缓冲区刷到磁盘）【最慢但安全】
- everysec：默认值。写入AOF文件，如果上次同步时间距现在超过1s，同步AOF。【可能丢失1s的数据】
- no：只写入AOF文件，**由系统决定何时同步**。【最快但不安全】
- 注意：这里的写入只是写入操作系统的内存缓冲区中。

服务器配置appendfsync选项的值直接决定AOF持久化功能的效率和安全性。



## AOF载入与还原

服务器只需要读入并执行一遍AOF文件中的写命令即可还原数据库状态，读取的步骤如下：

- 创建一个不带网络连接的伪客户端：因为命令只能在客户端执行
- 从AOF读取一条写命令
- 使用客户端执行该命令
- 重复上面的步骤，直到完成



## AOF重写

* BGREWRITEAOF命令执行重写。

* 随着时间流逝，AOF**文件内容会越来越大**【含有冗余命令】，影响redis性能。redis提供重写功能解决该问题。

* 重写是通过读**取redis当前数据状态完成的，而不是解析AOF文件**，其会创建**一个新的aof文件来代替现有的aof文件**，且新的aof文件**不会包含任何浪费空间的冗余命令**。【去库中读取键的值，然后用一条命令记录即可】

* 为了不影响redis正常响应，重写功能通过创建**子进程**（注意不是线程）完成，可以在避免使用锁的情况下，保证数据的安全性。

* 为了解决父子进程数据不一致问题（父进程接收新的请求），redis设置了**AOF重写缓冲区**。新的写命令在AOF缓冲区和AOF重写缓冲区中双写。

  * 从创建子进程开始，服务器执行的所有写命令会记录到AOF重写缓冲区中。
  * 子进程完成AOF重写工作之后，AOF重写缓冲区中的内容会被写入到新的AOF文件中。

  
