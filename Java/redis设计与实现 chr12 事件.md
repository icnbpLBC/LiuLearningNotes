---
title: redis设计与实现 chr12 事件
date: 2021-12-16 18:33:37
categories:	Redis基础
tags: Redis
---



# 总结

事件章节主要介绍文件事件和时间事件。文件时间是**对套接字操作**的事件，时间事件是**对定时操作**相关的事件。文件事件利用I/O多路复用程序**监听多个套接字**，根据相应的**可读/可写事件**来触发并移交给文件事件分派器，分派器会给具体的**事件处理器处理**。然后介绍了时间事件的组成，serverCron的职能，主要负责对资源的检查，更新，判断操作。对于两种事件同时出现情况的处理机制，利用**等待时间事件的空隙**作为文件事件的最大阻塞时间，然后先处理随机的文件事件，再处理时间事件。不浪费CPU资源，提高效率。

# 事件

Redis服务器是一个事件驱动程序，事件包括两大类：

- 文件事件：服务器对套接字操作的抽象。
- 时间事件：某些需要在给定时间执行的操作



## 文件事件

* redis基于**Reactor模型**开发了自己的**网络事件处理器**，这个处理器为**文件事件处理器。**
  * 文件事件处理器使用**IO 多路复用程序**来同时监听多个套接字，并根据套接字目前执行的任务为其**关联不同的事件处理器**（连接应答、命令请求、命令回复、复制）。
  * 当套接字准备好执行连接应答accept、读取read、写入write、关闭close等操作时，与操作相应的文件事件（可读、可写）就会产生，这时文件事件处理器会调用关联的文件事件处理器来处理这些事件。
  * 虽然事件处理器以单线程运行，通过io多路复用，能同时监听多个套接字实现高性能的网络通信模型。



### 文件事件处理器的构成

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/17/167bbec17e25c5e7~tplv-t2oaga2asx-watermark.awebp)

- 文件事件：套接字准备执行的操作的抽象【连接应答、写入、读取、关闭等】
- io多路复用程序：同时监听多个套接字，并向事件分派器**传送产生事件的套接字**。多个产生事件的套接字按队列排序。
- 文件事件分派器：接收套接字，根据产生的事件类型调用相应的事件处理器
- 事件处理器：一个个函数，定义了某个事件发生时，服务器应该执行的工作。

### IO多路复用程序的实现

可选的io多路复用程序包括select,epoll,evport,kqueue实现。每种实现都放在单独的文件中。编译时根据不同的宏切换不同的底层实现。

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/17/167bbf2f2b42de50~tplv-t2oaga2asx-watermark.awebp)





```c
#define AE_NONE 0       /* No events registered. */
#define AE_READABLE 1   /* Fire when descriptor is readable. */
#define AE_WRITABLE 2   /* Fire when descriptor is writable. */

```

### 处理器

redis为文件事件编写了多个处理器，分别用于实现不同的网络需求，在networking.c文件中，包括：

- 连接应答处理器：监听套接字，接收客户端连接请求。对应函数为acceptTcpHandler。内部调用socket编程的accpt函数
- 命令请求处理器：负责读入套接字中的命令请求内容。对应函数为readQueryFromClient。内部调用socket编程的read函数
- 命令回复处理器：负责将回复通过套接字返回给客户。对应函数为sendReplyToClient。内部调用socket班车的write函数

### **总结**

一次**完整的基于文件事件的服务器与客户端交互**，相关处理器的处理过程：

1. 客户端**发起连接**，产生**读事件**，触发连接应答处理器执行。创建套接字，客户端状态并将该套接字的读事件与命令请求处理器关联。
2. 客户端**发送命令**，产生**读事件**，触发命令请求处理器。读取执行命令产生相应回复并将该套接字的写事件与命令回复处理器关联。
3. 客户端**读取命令回复**，产生**写事件**，触发命令回复处理器。将回复写入套接字，解除写事件与命令回复处理器的关联。



//todo 暂看到这

## 时间事件

### 分类

时间事件分类以下两大类，取决于时间处理器的返回值：

- 定时事件：只在指定事件到达一次。如xx时间后执行一次。返回AE_NOMORE（-1）
- 周期性事件：非AE_NOMORE值。单机版只有serverCron一个周期性事件

**目前redis只使用周期性事件，没有使用定时事件。**

正常情况下，只使用serverCron一个时间事件，且其是周期性事件。

### 属性

时间事件包括三个属性：

- id：服务器创建的全局唯一标识
- when：事件到达时间 毫秒级unix时间戳，周期性事件在到达后会对该属性进行更新，让这个事件再一段时间后再次到达。
- timeProc：时间处理器，一个函数

****

### 实现

- 所有时间事件放在一个无序链表中，每当时间事件执行器运行时，遍历整个链表，找到已到达的时间事件，调用相应的事件处理器。新的事件总是插入到链表的表头。

  ![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/17/167bc1026e0f71bf~tplv-t2oaga2asx-watermark.awebp)

- 执行时需要遍历链表

- ae.c/aeCreateTimeEvent：创建时间处理器

- aeSearchNearestTimer：返回距离当前时间最近的时间事件

- ae.c/processTimeEvents：遍历时间事件并执行



## 事件调度

- 事件调度和执行由ae.c/aeProcessEvents函数负责
- 该函数被放在ae.c/aeMain函数中的一段循环里面，不断执行直到服务器关闭
- aeMain被server.c的main函数调用

