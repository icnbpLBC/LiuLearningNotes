# redis设计与实现 chr13 服务器

## 总结

服务器章节主要描述了Redi**s一条指令的执行过**程，从初始化到具体的过程细化，发送命令，读取命令，查找命令字典，执行预备操作，调用实现函数，善后工作，发送回复，客户端打印。



## 命令请求执行过程

* 发送命令请求
  * 客户端发送命令请求，且客户端会将命令请求转换为协议格式，再将其发给服务器。
* 读取命令请求
  * 客户端发送完命令请求后，服务器中对应的客户端套接字变得可读发出可读事件，命令请求处理器处理响应该可读事件，并进行以下操作
    * 读取协议格式得命令请求，将其写入客户端的输入缓冲区中。
    * 对缓冲区中的命令请求分析，分析出命令参数，以及命令参数的个数，分别保存到client的argv和argc属性里。
    * 调用命令执行器，执行命令。
* 命令执行器（1）：查找命令实现
  * 根据argv[0]参数在命令表中查找参数对应的命令，并将其保存到client的cmd属性中。
* 命令执行器（2）：执行预备操作
  * 在命令真正执行前需要有预备操作保证命令可以被正确，顺利地执行。这个环节相当于一层过滤，比如检查命令是否正确，参数是否正确，身份验证是否通过，内存是否够用等等。保证配置生效，准确执行。
* 命令执行器（3）：调用命令的实现函数
  * 执行过程就是调用之前找到并指向的执行函数。通过client->cmd->proc(client);调用。然后将协议格式的回复保存在客户端状态的输出缓冲区中，关联该套接字的命令回复处理器。
* 命令执行器（4）：执行后续工作
  * 有一些善后工作还将继续，比如慢查询日志记录，执行时长记录，AOF持久化，主服务器将命令传给从服务器。当这些都处理完后，服务器就继续从文件事件处理器中取出并执行下一个命令请求。
* 将命令回复发送给客户端
  * 当客户端套接字变为可写状态，服务器执行命令回复处理器，将输出缓冲区的回复发送给客户端。
* 客户端接受并打印命令回复
  * 将回复转为人类可读的格式，打印给用户看。



## serverCon函数

服务器中的serverCon函数默认每隔100毫秒执行一次，这个函数负责管理数据库资源，并保持服务器自身的良好运转。

下面是serverCon函数中的主要的操作。

* 更新服务器资源
* 更新LRU时钟
* 更新服务器每秒执行命令次数
* 更新服务器内存峰值记录
* 处理SIGTERM信号
* 管理客户端资源
* 管理数据库资源
* 执行被延迟的BGREWRITEAOF
* 检查持久化的运行状态
* 将AOF缓冲区中的内容写入AOF文件
* 关闭异步客户端
* 增加cronloops计数器的值



## 初始化服务器

服务器从启动到能够处理客户端的命令请求需要执行以下步骤：

* 初始化服务器状态。
  * 主要是对redisServer结构体的初始化，对server变量的相关配置属性设置默认值，包括设置服务器运行ID，运行频率，设置配置文件路径，设置持久化条件，命令表创建等。
* 载入服务器配置。
  * 根据用户给定的配置参数和配置文件，对server变量相关属性的值进行修改。比如端口号，数据库数量，RDB的压缩是否开启等等。其他属性还是沿用默认值。
* 初始化服务器数据结构。
  * 服务器必须先载入用户配置，才能对其他数据结构进行准确初始化。其他数据结构包括客户端链表，db数组，订阅信息，Lua脚本执行环境，慢查询日志相关属性等等。
* 还原数据库状态。
  * 载入RDB或AOF文件的数据恢复过程。
* 执行事件循环。
  * 事件循环即循环等待事件的出现并对其进行响应，至此，服务器可接收客户端请求并发送信息。

流程伪代码如下：

```c
def main():
# 初始化服务器
init_server()
# 事件循环
while server_is_not_shutdown():
	# 事件的调度和执行
	aeProcessEvents()
clean_server()
```



