

#  压缩列表

- ziplist【压缩列表】是列表键【List】和哈希键【Hash】的底层实现之一

- 当列表键只包含少量列表项，且每个列表项要么是**小整数**，要么是**短字符串**，就使用ziplist作为列表键底层实现。
- 当一个哈希键只包含少量键值对，且每个键值对的键和值要么是小整数，要么是短字符串，就使用ziplist作为哈希键底层实现



## 压缩列表的构成

- redis为了**节约内存**而开发的，由一系列特殊编码的连续内存块组成的**顺序型数据结构。**
- 一个压缩链表可以包含任意多个节点，**每个节点可以保存一个字节数组或者一个整数值。**

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/14/167acb15d0535cca~tplv-t2oaga2asx-watermark.awebp)

| 属性    | 类型     | 长度  | 用途                                                         |
| ------- | -------- | ----- | ------------------------------------------------------------ |
| zlbytes | uint32_t | 4字节 | 整个压缩列表占用的内存字节数                                 |
| zltail  | uint32_t | 4字节 | 表尾节点距离压缩列表起始地址有多少字节，无需遍历就可得到表尾节点。列表起始地址加这个值就是列表尾节点的地址 |
| zllen   | uint16_t | 2字节 | 节点数量，小于65535时是实际值，超过时需要遍历才能算出        |
| entryN  | 列表节点 | 不定  | 包含的各个节点                                               |
| zlend   | uint8_t  | 1字节 | 特殊值0xFF,末端标记                                          |



## 压缩列表节点的构成

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/14/167acb9bf2ab4cae~tplv-t2oaga2asx-watermark.awebp)

* previous_entry_length：单位为字节，前一个节点的长度，用于从表尾向表头回溯用【根据当前节点的起始地址和该值来计算出前一个节点的起始地址】
  * 如果前面节点长度小于254字节，previous_entry_length用1字节表示
  * 如果前面节点长度小于254字节，previous_entry_length用5字节表示，第1个字节为0xFE（254），后面四个字节表示实际长度

* encoding：记录content的类型以及长度，encoding分为两部分，高两位和余下的位数，最高两位的取值有以下情况：

| 最高两位取值 | content数据类型 | encoding字节数 | 余下的bit数                   | 最大范围                                |
| ------------ | --------------- | -------------- | ----------------------------- | --------------------------------------- |
| 00           | 字节数组        | 一个字节       | 6bit                          | 63字节的字节数组                        |
| 01           | 字节数组        | 两个字节       | 14bit                         | 2^14-1字节的字节数组                    |
| 10           | 字节数组        | 五个字节       | 4*8，第一个字节余下的6bit留空 | 2^32-1字节的字节数组                    |
| 11           | 整数            | 1个字节        | 000000                        | int16_t类型整数                         |
| 11           | 整数            | 1个字节        | 010000                        | int32_t类型整数                         |
| 11           | 整数            | 1个字节        | 100000                        | int64_t类型整数                         |
| 11           | 整数            | 1个字节        | 110000                        | 24位有符号整数                          |
| 11           | 整数            | 1个字节        | 111110                        | 8位有符号整数                           |
| 11           | 整数            | 1个字节        | xxxxxx                        | 没有content，xxxx本身就表示了0-12的整数 |

- content：保存节点的值，可以是字节数组或者整数，类型和长度由节点的encoding属性决定。



## 连锁更新

* 因previous_entry_length属性长度随着前一节点的长度变化，当添加新节点或删除节点时，可能有多个节点的previous_entry_length属性长度发生变化，此时**redis需进行连续多次的空间重分配操作**。
* 在实际情况下，这种情况比较少。

